services:
  # Discovery Server (Eureka)
  discovery-server:
    build:
      context: ./discovery-server
      dockerfile: Dockerfile
    container_name: discovery-server-local
    ports:
      - "8761:8761"
    environment:
      - PORT=8761
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8761"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mlops-network

  # Agent Service
  agent-service:
    build:
      context: ./agent-service
      dockerfile: Dockerfile
    container_name: agent-service-local
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      - EUREKA_SERVER_URL=http://discovery-server:8761
      - EUREKA_APP_NAME=AGENT-SERVICE
      - PREFER_IP=true
      - CHROME_MCP_URL=http://chrome-mcp:8000/mcp
      - LLM_TIMEOUT=300
      - LLM_API_KEY
      - LLM_PROVIDER=openai
      - LLM_BASE_URL=http://host.docker.internal:1234/v1
      - LLM_MODEL=zai-org/glm-4.7-flash
    depends_on:
      discovery-server:
        condition: service_healthy
      chrome-mcp:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mlops-network

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway-local
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - APP_NAME=API-GATEWAY
      - EUREKA_SERVER_URL=http://discovery-server:8761/eureka
      - AGENT_APP_NAME=AGENT-SERVICE
      - AGENT_BASE_URL=http://agent-service:5000
      - REQUEST_TIMEOUT=120s
      - PREFER_IP=true
    depends_on:
      discovery-server:
        condition: service_healthy
      agent-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mlops-network

  # MCP Chrome Server
  chrome-mcp:
    build:
      context: ./mcp-chrome
      dockerfile: Dockerfile
    container_name: chrome-mcp-local
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - CHROME_MCP_ARGS=--headless=true --isolated=true
    networks:
      - mlops-network

  # Frontend Service (Next.js)
  front-end:
    build:
      context: ./front-end
      dockerfile: Dockerfile
    container_name: front-end-local
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - API_GATEWAY_URL=http://api-gateway:8080
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - mlops-network

networks:
  mlops-network:
    driver: bridge

volumes: {}

